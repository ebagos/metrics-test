name: Weekly issue metrics
on:
  workflow_dispatch:
  schedule:
    - cron: '3 2 * * 0' # every Sunday 2:03am UTC

permissions:
  issues: write
  pull-requests: read

jobs:
  metrics_matrix:
    strategy:
      matrix:
        repo: ['metrics-test']
        owner: ['ebagos']
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_ACCESS_TOKEN }}

      - name: Get current date and time
        env: 
          TZ: "UTC" # タイムゾーンを指定
        id: date
        #run: echo "::set-output name=date::$(date +'%Y-%m-%d %H:%M:%S')"
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      # '%Y-%m-%d %H:%M'の部分を書き換えれば、任意の表示に変更できる。

      - name: Get previous week
        id: weekly
        uses: ./.github/actions/localdate
        env:
          TYPE: 'week'
          UTC: ${{ steps.date.outputs.date }}
          WEEKDAY: '0'
          TIMEZONE: 'Asia/Tokyo'

      - name: Output from date
        run: echo "${{ steps.weekly.outputs.first }}"

      - name: get commit infos
        uses: ./.github/actions/commits
        env:
          ACCESS_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
          FROM_DATE: ${{ steps.weekly.outputs.first }}
          TO_DATE: ${{ steps.weekly.outputs.last }}
          REPO_OWNER: ${{ matrix.owner }}
          REPO_NAME: ${{ matrix.repo }}
  
      - name: Run issue-metrics tool for issues opened in a specific period
        id: issue-metrics-created
        uses: github/issue-metrics@v2
        env:
          GH_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
          SEARCH_QUERY: 'repo:${{ matrix.owner }}/${{ matrix.repo }} is:issue created:${{ steps.weekly.outputs.first }}..${{ steps.weekly.outputs.last }}'

      # JSON output
      #- name: Print output of issue metrics tool
      #  run: echo "${{ steps.issue-metrics-created.outputs.metrics }}"

      #- name: Upload Release
      #  uses: actions/upload-artifact@v4
      #  with:
      #    name: issue-metrics
      #    path: ./issue_metrics.json

      - name: Create issue for created issues
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: 'Weekly issue metrics - opened issues'
          content-filepath: ./issue_metrics.md

      - name: Run issue-metrics tool for prs opened in a specific period
        id: pr-metrics-created
        uses: github/issue-metrics@v2
        env:
          GH_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
          SEARCH_QUERY: 'repo:${{ matrix.owner }}/${{ matrix.repo }} is:pr created:${{ steps.weekly.outputs.first }}..${{ steps.weekly.outputs.last }}'

      - name: Create issue for opend prs
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: 'Weekly pr metrics created'
          content-filepath: ./issue_metrics.md

      - name: Run issue-metrics tool for issues closed in a specific period
        id: issue-metrics-closed
        uses: github/issue-metrics@v2
        env:
          GH_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
          SEARCH_QUERY: 'repo:${{ matrix.owner }}/${{ matrix.repo }} is:issue closed:${{ steps.weekly.outputs.first }}..${{ steps.weekly.outputs.first }}'
  
      - name: Create issue for closed issues
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: 'Weekly pr metrics created'
          content-filepath: ./issue_metrics.md

      - name: Run issue-metrics tool for issues closed in a specific period
        id: pr-metrics-closed
        uses: github/issue-metrics@v2
        env:
          GH_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
          SEARCH_QUERY: 'repo:${{ matrix.owner }}/${{ matrix.repo }} is:pr closed:${{ steps.weekly.outputs.first }}..${{ steps.weekly.outputs.first }}'
    
      - name: Create issue for closed prs
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: 'Weekly pr metrics closed'
          content-filepath: ./issue_metrics.md
